---
- name: Set ClickHouse package name
  set_fact:
    clickhouse_common_pkg: "clickhouse_common-{{ clickhouse_version }}.rpm"
    clickhouse_server_pkg: "clickhouse_server-{{ clickhouse_version }}.rpm"
    clickhouse_client_pkg: "clickhouse_client-{{ clickhouse_version }}.rpm"

- name: Copy local package to remote
  copy: src="{{ item.src }}" dest="{{ item.dest }}" mode=0755
  with_items:
    - {src: "{{ downloads_dir }}/{{ clickhouse_common_pkg }}", dest: "{{ clickhouse_root_dir }}"}
    - {src: "{{ downloads_dir }}/{{ clickhouse_server_pkg }}", dest: "{{ clickhouse_root_dir }}"}
    - {src: "{{ downloads_dir }}/{{ clickhouse_client_pkg }}", dest: "{{ clickhouse_root_dir }}"}
  sudo: yes

- name: Remove ClickHouse package.
  yum:
    name: 
      - clickhouse-common-static
      - clickhouse-common
      - clickhouse-server
      - clickhouse-client
      - clickhouse*
    state: absent
  sudo: yes

- name: Install ClickHouse Common package.
  shell: rpm -ivh "{{ clickhouse_root_dir }}/{{ clickhouse_common_pkg }}"
  args:
    warn: false
  sudo: yes

- name: Install ClickHouse Server package.
  shell: rpm -ivh "{{ clickhouse_root_dir }}/{{ clickhouse_server_pkg }}"
  args:
    warn: false
  sudo: yes

- name: Install ClickHouse Client package.
  shell: rpm -ivh "{{ clickhouse_root_dir }}/{{ clickhouse_client_pkg }}"
  args:
    warn: false
  sudo: yes

- name: Create ClickHouse directory
  file:
    path: "{{ item }}"
    owner: clickhouse 
    group: clickhouse 
    mode: 0755
    state: directory
  with_items:
    - "/etc/{{ clickhouse_server_name }}"
    - "/etc/{{ clickhouse_server_name }}/config.d"
    - "/etc/{{ clickhouse_server_name }}/users.d"
    - "{{ clickhouse_root_dir }}/clickhouse"
    - "{{ clickhouse_root_dir }}/clickhouse/data"
    - "{{ clickhouse_root_dir }}/clickhouse/log"
  sudo: yes

- name: Create ClickHouse configuration file.
  template: src="config.xml.j2" dest="/etc/{{ clickhouse_server_name }}/config.xml" mode=0644
  sudo: yes

- name: Create ClickHouse users file.
  template: src="users.xml.j2" dest="/etc/{{ clickhouse_server_name }}/users.xml" mode=0644
  sudo: yes

- name: Create ClickHouse metrika file.
  template: src="metrika.xml.j2" dest="/etc/{{ clickhouse_server_name }}/metrika.xml" mode=0644
  sudo: yes

- name: Create ClickHouse init.d file.
  template: src="init.d.j2" dest="/etc/init.d/{{ clickhouse_server_name }}" mode=0755
  sudo: yes

- name: Create ClickHouse cron.d file.
  template: src="cron.d.j2" dest="/etc/cron.d/{{ clickhouse_server_name }}" mode=0644
  sudo: yes
